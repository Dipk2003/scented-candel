name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint -- --fix
      continue-on-error: true
    
    - name: Build project
      run: npm run build
    
    - name: Upload build artifacts
      if: matrix.node-version == '20.x'
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          .next/
          public/
          package.json
          package-lock.json
          README.md
        retention-days: 30

  build-and-release:
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter (if configured)
      run: npm run lint -- --fix
      continue-on-error: true
    
    - name: Build project
      run: npm run build
    
    - name: Create release archive
      run: |
        mkdir -p release
        cp -r .next public package.json package-lock.json README.md database-setup.sql release/
        cd release && zip -r ../scented-candles-${{ github.ref_name }}.zip .
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Scented Candles E-commerce Platform ${{ github.ref_name }}
        body: |
          ## ğŸ•¯ï¸ Scented Candles E-commerce Platform - ${{ github.ref_name }}
          
          ### ğŸš€ Production Ready Release
          
          This release contains a **fully-featured, production-ready e-commerce platform** for selling scented candles online.
          
          ### âœ¨ Key Features
          - ğŸ›’ Complete e-commerce functionality (cart, checkout, payments)
          - ğŸ’³ Razorpay payment gateway integration
          - ğŸ” Clerk authentication system
          - ğŸ“± Mobile-responsive design
          - ğŸ¨ Modern UI with Tailwind CSS
          - ğŸ“Š Admin dashboard for product management
          - ğŸ“§ Automated email notifications
          - ğŸ—„ï¸ Supabase database integration
          
          ### ğŸ“¦ What's Included
          - Complete Next.js application
          - Database schema (database-setup.sql)
          - Production-ready configuration
          - Comprehensive documentation
          
          ### ğŸ› ï¸ Technology Stack
          - **Frontend**: Next.js 15 + React 19 + Tailwind CSS
          - **Backend**: Next.js API Routes + Supabase
          - **Database**: PostgreSQL (via Supabase)
          - **Auth**: Clerk Authentication
          - **Payment**: Razorpay Gateway
          - **Email**: Nodemailer
          
          ### ğŸš€ Quick Start
          1. Download and extract the release
          2. Run `npm install`
          3. Configure environment variables (.env.local)
          4. Set up Supabase database using database-setup.sql
          5. Run `npm run dev`
          
          ### ğŸ“š Documentation
          Complete setup and deployment instructions are included in the README.md file.
          
          ---
          
          **Ready for immediate production deployment! ğŸ‰**
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./scented-candles-${{ github.ref_name }}.zip
        asset_name: scented-candles-${{ github.ref_name }}.zip
        asset_content_type: application/zip

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Deploy notification
      run: |
        echo "ğŸš€ Release ${{ github.ref_name }} is ready for deployment!"
        echo "ğŸ“¦ Download the release artifacts from GitHub Releases"
        echo "ğŸŒ Deploy to your preferred hosting platform (Vercel, Netlify, etc.)"
